# План разработки системы форматирования сообщений

## Отчет по прогрессу
- **Итерация 1**: ✅ Базовая структура модулей форматирования
- **Итерация 2**: ✅ Математические выражения и Unicode символы
- **Итерация 3**: ✅ Образовательные шаблоны и эмодзи
- **Итерация 4**: ✅ Интеграция в обработчики бота
- **Итерация 5**: ✅ Обновление промптов и тестирование
- **Итерация 6**: ✅ Мониторинг и конфигурация

## Статус: ЗАВЕРШЕНО ✅

Все итерации плана успешно выполнены. Система форматирования сообщений полностью реализована и протестирована.

---

## Итерация 1: Базовая структура модулей форматирования
**Цель**: Создать основную архитектуру системы форматирования

- [ ] Создать директорию `core/formatting/` с файлом `__init__.py`
- [ ] Создать базовый класс `TelegramFormatter` в `core/formatting/telegram_formatter.py`
- [ ] Добавить метод `format_message()` с базовой обработкой текста
- [ ] Создать простой тест для проверки работы базового форматтера
- [ ] Убедиться, что бот может импортировать и использовать форматтер

**Результат**: Бот может принимать текст и возвращать его без изменений через форматтер

---

## Итерация 2: Математические выражения и Unicode символы
**Цель**: Добавить поддержку математических выражений

- [ ] Создать класс `MathConverter` в `core/formatting/math_converter.py`
- [ ] Реализовать преобразование `\( ... \)` в `<code>...</code>`
- [ ] Добавить конвертацию степеней `x^2` → `x²`
- [ ] Добавить конвертацию корней `sqrt(x)` → `√x`
- [ ] Интегрировать `MathConverter` в `TelegramFormatter`
- [ ] Создать тесты для математических преобразований

**Результат**: Бот корректно отображает математические выражения в Telegram

---

## Итерация 3: Образовательные шаблоны и эмодзи
**Цель**: Добавить структурирование образовательного контента

- [ ] Создать класс `EducationalTemplates` в `core/formatting/educational_templates.py`
- [ ] Добавить форматирование секций: "Например:", "Решение:", "Ответ:"
- [ ] Реализовать преобразование списков в HTML-формат
- [ ] Интегрировать шаблоны в основной форматтер
- [ ] Создать тесты для образовательных шаблонов

**Результат**: Образовательный контент имеет структурированный вид с эмодзи и форматированием

---

## Итерация 4: Интеграция в обработчики бота
**Цель**: Подключить форматирование к отправке сообщений

- [ ] Импортировать `TelegramFormatter` в `bot/handlers.py`
- [ ] Добавить форматирование в обработчик текстовых сообщений
- [ ] Реализовать fallback на plain text при ошибках HTML
- [ ] Добавить логирование успешного/неуспешного форматирования
- [ ] Протестировать отправку отформатированных сообщений в Telegram

**Результат**: Все сообщения от бота автоматически форматируются перед отправкой

---

## Итерация 5: Обновление промптов и тестирование
**Цель**: Настроить LLM для генерации совместимого контента

- [ ] Обновить `core/prompts/system_base.txt` с инструкциями по форматированию
- [ ] Добавить примеры использования математических обозначений
- [ ] Создать комплексные тесты для всего пайплайна форматирования
- [ ] Протестировать различные типы образовательного контента
- [ ] Убедиться в корректной работе с существующими командами бота

**Результат**: LLM генерирует контент, который корректно форматируется и отображается

---

## Итерация 6: Мониторинг и конфигурация
**Цель**: Добавить настройки и мониторинг системы форматирования

- [ ] Добавить настройки форматирования в `settings/config.py`
- [ ] Создать возможность отключения форматирования через конфиг

**Результат**: Система форматирования полностью настроена, мониторится и готова к продакшену

---

## Ссылки на документацию
- [Техническое описание фичи](@doc/message_formatting.md)
- [Архитектура проекта](@doc/vision.md)
- [План рефакторинга](@doc/refactoring_plan.md)
