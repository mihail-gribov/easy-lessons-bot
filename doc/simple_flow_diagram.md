# Простая схема потока обработки сообщений

## ASCII-диаграмма основного потока

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Пользователь  │───▶│  Telegram API    │───▶│  aiogram Bot    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Ответ бота     │◀───│  Telegram API    │◀───│  Handlers       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ MessageProcessor│
                                               └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   SQLite DB     │◀───│ SessionManager   │◀───│ Извлечение      │
└─────────────────┘    └──────────────────┘    │ контента        │
                                               └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ Вспомогательная │
                                               │ модель (анализ) │
                                               └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ ContextProcessor│
                                               └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  OpenRouter API │◀───│ Диалоговая       │◀───│ DialogBuilder   │
│                 │    │ модель           │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ TelegramFormatter│
                                               └─────────────────┘
```

## Детальная схема обработки по типам сообщений

```
Входящее сообщение
        │
        ▼
    ┌─────────┐
    │ Тип?    │
    └─────────┘
        │
    ┌───┴───┐
    │       │
    ▼       ▼
┌─────┐ ┌─────┐
│Текст│ │Медиа│
└─────┘ └─────┘
    │       │
    ▼       ▼
┌─────┐ ┌─────────────┐
│Прямо│ │Скачивание   │
│     │ │файла        │
└─────┘ └─────────────┘
    │       │
    ▼       ▼
┌─────┐ ┌─────────────┐
│     │ │Обработка    │
│     │ │(Whisper/    │
│     │ │Vision API)  │
└─────┘ └─────────────┘
    │       │
    └───┬───┘
        │
        ▼
┌─────────────┐
│Добавление в │
│историю      │
└─────────────┘
        │
        ▼
┌─────────────┐
│Анализ       │
│контекста    │
│(вспомогат.  │
│модель)      │
└─────────────┘
        │
        ▼
┌─────────────┐
│Обработка    │
│контекста    │
└─────────────┘
        │
        ▼
┌─────────────┐
│Построение   │
│диалога      │
└─────────────┘
        │
        ▼
┌─────────────┐
│Генерация    │
│ответа       │
│(диалоговая  │
│модель)      │
└─────────────┘
        │
        ▼
┌─────────────┐
│Форматирование│
│для Telegram │
└─────────────┘
        │
        ▼
┌─────────────┐
│Отправка     │
│ответа       │
└─────────────┘
```

## Схема компонентов системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Easy Lessons Bot                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Входной   │  │    Ядро     │  │  Выходной   │        │
│  │    слой     │  │   системы   │  │    слой     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                 │                 │              │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐        │
│  │aiogram      │  │Message      │  │Telegram     │        │
│  │Handlers     │  │Processor    │  │Formatter    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                 │                 │              │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐        │
│  │Media        │  │Session      │  │Math         │        │
│  │Handlers     │  │Manager      │  │Converter    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                 │                 │              │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐        │
│  │Media        │  │Prompt       │  │Educational  │        │
│  │Processor    │  │Store        │  │Templates    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                 │                               │
│  ┌──────▼──────┐  ┌──────▼──────┐                        │
│  │Audio        │  │Context      │                        │
│  │Handler      │  │Analyzer     │                        │
│  └─────────────┘  └─────────────┘                        │
│         │                 │                               │
│  ┌──────▼──────┐  ┌──────▼──────┐                        │
│  │Image        │  │Dialog       │                        │
│  │Analyzer     │  │Builder      │                        │
│  └─────────────┘  └─────────────┘                        │
│                                                           │
├─────────────────────────────────────────────────────────────┤
│                    Внешние сервисы                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │Telegram API │  │OpenRouter   │  │Whisper API  │        │
│  │             │  │API          │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │GPT-4 Vision │  │SQLite       │  │File System  │        │
│  │API          │  │Database     │  │(logs, temp) │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Схема двухмодельной архитектуры

```
                    Входящее сообщение
                            │
                            ▼
                    ┌─────────────┐
                    │ Извлечение  │
                    │ контента    │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Добавление  │
                    │ в историю   │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Вспомогательная │
                    │ модель      │
                    │ (анализ)    │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Context     │
                    │ Processor   │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Dialog      │
                    │ Builder     │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Диалоговая  │
                    │ модель      │
                    │ (генерация) │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Форматирование│
                    │ и отправка  │
                    └─────────────┘
```

## Схема обработки ошибок

```
                    Нормальная обработка
                            │
                            ▼
                    ┌─────────────┐
                    │ Попытка     │
                    │ выполнения  │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Успешно?    │
                    └─────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
            ┌─────────────┐ ┌─────────────┐
            │ Да          │ │ Нет         │
            │             │ │             │
            └─────────────┘ └─────────────┘
                    │               │
                    ▼               ▼
            ┌─────────────┐ ┌─────────────┐
            │ Продолжить  │ │ Тип ошибки? │
            │ нормально   │ │             │
            └─────────────┘ └─────────────┘
                                    │
                                    ▼
                            ┌─────────────┐
                            │ LLM ошибка  │
                            │ → Повтор    │
                            │ DB ошибка   │
                            │ → In-memory │
                            │ Медиа ошибка│
                            │ → Fallback  │
                            └─────────────┘
```

Эта простая схема показывает основные потоки обработки сообщений в Easy Lessons Bot в удобном для понимания формате.
